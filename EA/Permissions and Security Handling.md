## ‚úÖ **EA Architectural Design Document: Permissions and Security Handling**  
**Purpose:**  
This document defines the permissions and security handling strategy for the Expert Advisor (EA) for the Trade Distribution System. The EA will have direct access to sensitive trade-related data (account credentials, trade signals, order state) and handle low-latency real-time tick data transmission. A robust security framework is essential to ensure:  
- Controlled access to trading accounts and trade execution functions.  
- Secure communication of tick data and trade orders.  
- Prevention of unauthorized access and privilege escalation.  

---

## **1. Scope**  
The security and permissions framework will cover the following EA components:  
‚úÖ **Trade Engine** ‚Üí Handles trade execution and state updates.  
‚úÖ **Tick Stream Handler** ‚Üí Handles real-time and historical data transmission.  
‚úÖ **Redis Buffer** ‚Üí Houses real-time trade and account state data.  
‚úÖ **WebSocket Connection** ‚Üí Secure communication with TradingView.  
‚úÖ **Network Protocols** ‚Üí UDP/TCP encryption and authentication.  
‚úÖ **MT5 Account Management** ‚Üí Secure storage and handling of login credentials.  

---

## **2. EA Execution Permissions**  
The EA will run with the **minimum possible permissions** to reduce security exposure:  

### ‚úÖ **MT5 Terminal Permissions:**  
| Permission | Required | Description |
|------------|----------|-------------|
| **Read Tick Data** | ‚úÖ Yes | Required to read incoming tick data |
| **Execute Trade Orders** | ‚úÖ Yes | Required to place and modify orders |
| **Modify Account State** | ‚ùå No | EA will not modify account state (only retrieve) |
| **Modify User Configuration** | ‚úÖ Yes | Required to adjust lot sizes, SL/TP, etc. |
| **Terminal Reconnection** | ‚úÖ Yes | Required to handle auto-reconnection |
| **Indicator/Chart Access** | ‚ùå No | Disabled to reduce memory footprint |
| **Market History Access** | ‚úÖ Yes | Required for historical backfill |
| **Account Balance/Equity Access** | ‚úÖ Yes | Required for position and margin calculation |

---

### ‚úÖ **Filesystem Permissions:**  
| Permission | Required | Description |
|------------|----------|-------------|
| **Read from Filesystem** | ‚úÖ Yes | Load configuration from JSON files |
| **Write to Filesystem** | ‚úÖ Yes | Save instance-specific data (tick buffer, logs) |
| **Delete Files** | ‚ùå No | EA will not delete any files |
| **Modify Configuration** | ‚úÖ Yes | User-controlled configuration updates |
| **Access Protected Files** | ‚ùå No | No access to sensitive OS files |
| **Executable Permissions** | ‚úÖ Yes | Minimum permissions required to run EA executable |

---

### ‚úÖ **Network Permissions:**  
| Permission | Required | Description |
|------------|----------|-------------|
| **UDP Port** (8123) | ‚úÖ Yes | For low-latency tick transmission |
| **TCP Port** (9000) | ‚úÖ Yes | For reliable transmission and historical backfill |
| **WebSocket** (8001) | ‚úÖ Yes | For status confirmation and order state updates |
| **Remote Host Connection** | ‚úÖ Yes | Required for TradingView connectivity |
| **Inbound Traffic** | ‚úÖ Yes | Only from MT5 and backend |
| **Outbound Traffic** | ‚úÖ Yes | Only to TradingView and backend |

---

## **3. Authentication and Authorization**  
### ‚úÖ **1. Trading Account Authentication:**  
1. Login credentials stored in **PostgreSQL** (encrypted).  
2. EA pulls login credentials from backend during initialization.  
3. EA only allowed to use credentials assigned to that instance.  
4. Credentials pulled using **TLS 1.2** connection.  
5. Invalid credentials ‚Üí EA will reject execution.  

---

### ‚úÖ **2. WebSocket Authentication:**  
1. EA will authenticate to TradingView using a **JWT token**.  
2. JWT token generated by the backend and verified before connection.  
3. Token expiry ‚Üí Auto-renew every 24 hours.  
4. Invalid token ‚Üí EA will terminate the WebSocket connection.  

---

### ‚úÖ **3. UDP/TCP Authentication:**  
1. UDP is connectionless ‚Üí No direct authentication.  
2. EA signs UDP payload using HMAC (SHA-256) to prevent tampering.  
3. TCP transmission authenticated using mutual TLS handshake.  
4. Invalid HMAC signature ‚Üí Drop the packet.  

---

### ‚úÖ **4. Redis Authentication:**  
1. Redis protected with password-based authentication.  
2. EA connects to Redis with the assigned password.  
3. Redis connection is secured with TLS.  
4. Unauthorized connection attempt ‚Üí EA will terminate Redis connection.  

---

### ‚úÖ **5. Backend Authentication:**  
1. EA communicates with backend using **HTTP over TLS**.  
2. Backend generates a unique token for each EA session.  
3. Token linked to instance UUID ‚Üí Cannot be reused by other instances.  
4. Token expiry ‚Üí Auto-renew every 1 hour.  

---

## **4. Security Hardening**  
### ‚úÖ **1. EA Binary Protection:**  
1. EA binary will be **digitally signed** to prevent tampering.  
2. Executable will have a unique hash that must match the backend‚Äôs reference hash.  
3. Hash mismatch ‚Üí EA will not start.  

---

### ‚úÖ **2. Encrypted Configuration Files:**  
1. JSON configuration files will be AES-256 encrypted.  
2. Encryption key stored in secure storage on the backend.  
3. EA will decrypt the configuration upon initialization.  
4. Corrupted or modified file ‚Üí EA will reject configuration load.  

---

### ‚úÖ **3. Secure Network Configuration:**  
- **UDP:**  
    - Transmission secured using HMAC-SHA256.  
    - Data payload size capped at **512 bytes**.  
    - Payload TTL = 1 second ‚Üí Drop if delayed.  

- **TCP:**  
    - Mutual TLS authentication.  
    - Transmission rate throttled if congestion detected.  

- **Redis:**  
    - Redis bound to `127.0.0.1` (localhost only).  
    - Password-based authentication enforced.  

- **Backend:**  
    - Connection limited to known static IPs.  
    - Rate limiting enforced ‚Üí 10 requests/sec.  

---

### ‚úÖ **4. User Role and Access:**  
| Role | Permissions | Notes |
|-------|-------------|-------|
| **Admin** | Full | Create, delete, modify EA instances |
| **Trader** | Partial | Modify trade settings, cannot delete instances |
| **Viewer** | Read-Only | Can monitor trade state, cannot modify settings |

---

### ‚úÖ **5. Secure Data Transmission:**  
| Data Type | Transport | Encryption | Protocol |
|-----------|-----------|------------|----------|
| **Tick Data** | UDP/TCP | HMAC-SHA256 | UDP ‚Üí TCP |
| **Trade State** | Redis | Password-protected | TLS |
| **Configuration** | HTTP | AES-256 | TLS |
| **Credentials** | HTTP | AES-256 | TLS |
| **Order Status** | WebSocket | JWT | TLS |

---

## **5. Security Edge Cases**  
| Scenario | Impact | Resolution |
|----------|--------|------------|
| **Lost Credentials** | Trade halt | Request re-authentication from backend |
| **Session Hijack** | Unauthorized trades | Terminate session; re-authenticate |
| **Redis Compromise** | Inconsistent state | Wipe Redis; reinitialize from backend |
| **Invalid Token** | Rejected connection | Terminate session and retry |
| **High Network Latency** | Lost ticks | Reduce tick frequency |
| **Connection Failure** | Data loss | Attempt reconnect; notify backend |
| **MT5 Permission Revoke** | Rejected connection | Notify user; halt trading |
| **Tampered Binary** | Failure to start | Verify signature ‚Üí Terminate if mismatched |

---

## **6. Performance Tuning for Security**  
‚úÖ EA memory allocation limited to **128MB** to prevent memory-based attacks.  
‚úÖ HMAC signature calculation optimized for low-latency.  
‚úÖ Token-based authentication capped at **100 requests/sec**.  
‚úÖ Redis connection timeout set to **5 seconds** to prevent hanging.  
‚úÖ Max open socket connections = **10** ‚Üí Prevents socket flooding.  

---

## **7. High Availability and Resilience**  
‚úÖ EA instance will attempt auto-reconnect if connection to Redis or backend fails.  
‚úÖ Redis state retained for **30 seconds** during reconnect attempts.  
‚úÖ JWT auto-renew every 24 hours ensures session consistency.  
‚úÖ If MT5 crashes ‚Üí EA will attempt restart within **3 seconds**.  

---

## **8. Fault Tolerance**  
‚úÖ Lost UDP ‚Üí No retransmit (drop).  
‚úÖ Lost TCP ‚Üí Retransmit with exponential backoff.  
‚úÖ Redis connection loss ‚Üí Reinitialize connection.  
‚úÖ Binary hash mismatch ‚Üí Terminate EA and alert admin.  

---

## üöÄ **‚úÖ We now have a complete EA Permissions and Security Handling Design!**  
üëâ Next: Should we proceed to EA Performance Tuning or Edge Case Handling?